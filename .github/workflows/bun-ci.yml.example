name: CI/CD with Bun

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test with Bun
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build shared types
        run: |
          cd packages/shared
          bun run build

      - name: Lint frontend
        run: |
          cd packages/frontend
          bun run lint

      - name: Run backend tests
        run: |
          cd packages/backend
          bun test

      - name: Run backend tests with coverage
        run: |
          cd packages/backend
          bun test --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./packages/backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  build:
    name: Build with Bun
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build all packages
        run: |
          cd packages/shared && bun run build
          cd ../backend && bun run build
          cd ../frontend && bun run build

      - name: Upload backend build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: backend-dist
          path: packages/backend/dist

      - name: Upload frontend build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-dist
          path: packages/frontend/dist

  # Optional: Deploy job (customize for your deployment target)
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend artifacts
        uses: actions/download-artifact@v3
        with:
          name: backend-dist
          path: packages/backend/dist

      - name: Download frontend artifacts
        uses: actions/download-artifact@v3
        with:
          name: frontend-dist
          path: packages/frontend/dist

      # Add your deployment steps here
      # Examples:
      # - Deploy to AWS, Google Cloud, Azure
      # - Deploy to Vercel, Netlify, Railway
      # - Deploy via SSH to your server

      - name: Deploy notification
        run: echo "ðŸš€ Deployment would happen here"
